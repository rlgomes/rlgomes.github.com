<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Tuning the Java Garbage Collector</title>
        <meta name="description" content="Rodney's Blog">
        <meta name="author" content="Rodney Gomes">

        <link rel="alternate"
              type="application/rss+xml"
              title="Rodney's Corner RSS Feed"
              href="http://feeds.feedburner.com/rlgomesgithubcom/feed"/>

        <link href="/css/bootstrap.css" rel="stylesheet">
        <link href="/css/main.css" rel="stylesheet"/>
    </head>
    <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Rodney's Corner</a>
          <ul class="nav">
            <li class="active"><a href="/">Blog</a></li>
            <li><a href="/archive.html">Archive</a></li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content">
        <div class="page-header">
          <h1>Tuning the Java Garbage Collector</h1>
        </div>
        <div class="row">
          <div class="span10">
             <article>
                   <div id="post.body"><p>Recently, I&#8217;ve found a few situations where when writing a prototype for multi-node storage software that I want to be able to gaurantee the stability of my performance numbers as the number of concurent requests grows and the JVM is under high stress where the GC kicks in more often and has the unfortunate effect of adding higher latency to your requests.</p>

<p>Recently, I wanted to learn a bit more about the Java GC and how an applications performance can be &#8220;fixed&#8221; by tweaking the garbage collector being used. We&#8217;ll start by creating an application that will force the JVM to garbage collect more often: Call a function in a loop and this function will create a large object and calculate something complex (log(n)) and then throw away the object.</p>

<p>We will always run the application with the JVM option: <strong>&#8220;-Xmx64M&#8221;</strong> which basically means we can&#8217;t use more than 64MB during our test runs and this allows us to force the GC to kick-in more oftenly. Our slow/bad application can be as simple as:</p>
<div class='highlight'><pre><code class='java'><span class='cm'>/**</span>
<span class='cm'> * Call a function in a loop and this function will create a large object</span>
<span class='cm'> * and calculate something complex (log(n)) and then throw away the object.</span>
<span class='cm'> */</span>
<span class='kd'>public</span> <span class='kd'>class</span> <span class='nc'>BadApp1</span> <span class='o'>{</span>

    <span class='cm'>/**</span>
<span class='cm'>     * Generate a large array of integers and then calculate which is the</span>
<span class='cm'>     * maximum value and returns that releasing the large object previously</span>
<span class='cm'>     * created.</span>
<span class='cm'>     */</span>
    <span class='kd'>public</span> <span class='kd'>static</span> <span class='kt'>int</span> <span class='nf'>maximum_random</span><span class='o'>()</span> <span class='o'>{</span>
        <span class='kt'>int</span><span class='o'>[]</span> <span class='n'>random_integers</span> <span class='o'>=</span> <span class='k'>new</span> <span class='kt'>int</span><span class='o'>[</span><span class='mi'>10</span><span class='o'>*</span><span class='mi'>1024</span><span class='o'>*</span><span class='mi'>1024</span><span class='o'>];</span>
        <span class='kt'>int</span> <span class='n'>maximum</span> <span class='o'>=</span> <span class='n'>random_integers</span><span class='o'>[</span><span class='mi'>0</span><span class='o'>];</span>

        <span class='k'>for</span> <span class='o'>(</span><span class='kt'>int</span> <span class='n'>value</span> <span class='o'>:</span> <span class='n'>random_integers</span><span class='o'>)</span> <span class='o'>{</span>
            <span class='k'>if</span> <span class='o'>(</span> <span class='n'>maximum</span> <span class='o'>&lt;</span> <span class='n'>value</span> <span class='o'>)</span> <span class='n'>maximum</span> <span class='o'>=</span> <span class='n'>value</span><span class='o'>;</span>
        <span class='o'>}</span>

        <span class='k'>return</span> <span class='n'>maximum</span><span class='o'>;</span>
    <span class='o'>}</span>

    <span class='kd'>public</span> <span class='kd'>static</span> <span class='kt'>void</span> <span class='nf'>main</span><span class='o'>(</span><span class='n'>String</span><span class='o'>[]</span> <span class='n'>args</span><span class='o'>)</span> <span class='o'>{</span>

        <span class='kt'>long</span> <span class='n'>durations</span> <span class='o'>=</span> <span class='mi'>0</span><span class='o'>;</span>
        <span class='kt'>long</span> <span class='n'>duration</span> <span class='o'>=</span> <span class='mi'>0</span><span class='o'>;</span>
        <span class='kt'>long</span> <span class='n'>start</span><span class='o'>,</span> <span class='n'>stop</span><span class='o'>;</span>
        <span class='k'>for</span><span class='o'>(</span><span class='kt'>int</span> <span class='n'>i</span> <span class='o'>=</span> <span class='mi'>0</span><span class='o'>;</span> <span class='n'>i</span> <span class='o'>&lt;</span> <span class='mi'>100</span><span class='o'>;</span> <span class='n'>i</span><span class='o'>++)</span> <span class='o'>{</span>
            <span class='n'>start</span> <span class='o'>=</span> <span class='n'>System</span><span class='o'>.</span><span class='na'>currentTimeMillis</span><span class='o'>();</span>
            <span class='n'>maximum_random</span><span class='o'>();</span>
            <span class='n'>stop</span> <span class='o'>=</span> <span class='n'>System</span><span class='o'>.</span><span class='na'>currentTimeMillis</span><span class='o'>();</span>
            <span class='n'>duration</span> <span class='o'>=</span> <span class='o'>(</span><span class='n'>stop</span><span class='o'>-</span><span class='n'>start</span><span class='o'>);</span>
            <span class='n'>durations</span> <span class='o'>+=</span> <span class='n'>duration</span><span class='o'>;</span>
            <span class='n'>System</span><span class='o'>.</span><span class='na'>out</span><span class='o'>.</span><span class='na'>println</span><span class='o'>(</span><span class='s'>&quot;calculation took &quot;</span> <span class='o'>+</span> <span class='n'>duration</span> <span class='o'>+</span> <span class='s'>&quot;ms&quot;</span><span class='o'>);</span>
        <span class='o'>}</span>

        <span class='n'>System</span><span class='o'>.</span><span class='na'>out</span><span class='o'>.</span><span class='na'>println</span><span class='o'>(</span><span class='s'>&quot;average duration was &quot;</span> <span class='o'>+</span> <span class='n'>durations</span><span class='o'>/</span><span class='mi'>100</span> <span class='o'>+</span> <span class='s'>&quot;ms&quot;</span><span class='o'>);</span>
    <span class='o'>}</span>
<span class='o'>}</span>
</code></pre>
</div>
<p>When we start analyzing how much time it takes to run that program and in each iteration print out how long we spent calculating the maximum value along with running with the following options:</p>

<p>java -Xmx64M -XX:+PrintGCApplicationStoppedTime BadApp1</p>

<p>The <strong>-XX:+PrintGCAppliactionStoppedTime</strong> tells the JVM to print out exactly how much time is the GC taking and not allowing the application to do its work. Here is a quick output of what I&#8217;m currently getting on my system:</p>
<console>
>java -Xmx64M -XX:+PrintGCApplicationStoppedTime BadApp1
...
Total time for which application threads were stopped: 0.0117340 seconds
calculation took 68ms
Total time for which application threads were stopped: 0.0116940 seconds
calculation took 69ms
average duration was 69ms
</console>
<p>Now we can see that we&#8217;re spending a good 0.012s in garbage collection code on every single iteration, which is basically 12ms of time in each of those 69ms of average time spent calling that &#8220;bad&#8221; function.</p>

<p>Before we start trying out different garbage collectors and tweaking their settings you should read some of the following links first:</p>

<ul>
<li>http://www.oracle.com/technetwork/systems/index-156457.html</li>

<li>http://www.petefreitag.com/articles/gctuning/</li>
</ul>

<p>if you want a better explanation of how the various garbage collectors work.</p>

<p>So getting back to our situation we&#8217;re suffering a 12ms overhead from the GC in every execution of ours and would like to reduce that by tuning the GC. The first idea might be to try and use the <strong>Parallel Copy Collector</strong> and see if this reduces the over head slightly:</p>
<console>
> java -Xmx64M -XX:+UseParNewGC -XX:+PrintGCApplicationStoppedTime BadApp1
...
Total time for which application threads were stopped: 0.0110810 seconds
calculation took 64ms
Total time for which application threads were stopped: 0.0075140 seconds
calculation took 62ms
average duration was 65ms
</console>
<p>A very minimal improvement which isn&#8217;t totally new since the only thing being done by this garbage collector is to have a thread per core when collecting the young generation garbage. Since my machine is a dual core machine and there really is only 1 object to garbage collect in my code then I don&#8217;t expect almost any improvement.</p>

<p>For the particular application that we wrote could benefit from a garbage collector that has to deal with a large young generation and as the documentation states:</p>

<p>&#8220;Use the throughput collector when you want to improve the performance of your application with larger numbers of processors. In the default collector garbage collection is done by one thread, and therefore garbage collection adds to the serial execution time of the application. The throughput collector uses multiple threads to execute a minor collection and so reduces the serial execution time of the application.&#8221;</p>

<p>So lets see what the benefit is like:</p>
<console>
>java -Xmx64M -XX:+UseParallelGC -XX:+PrintGCApplicationStoppedTime BadApp1
...
Total time for which application threads were stopped: 0.0042150 seconds
calculation took 46ms
Total time for which application threads were stopped: 0.0053080 seconds
calculation took 45ms
average duration was 48ms
</console>
<p>Now we&#8217;re 30% faster just by making a better choice in the GC being used. We&#8217;ve gotten this &#8220;additional boost in performance&#8221; by now spending just 4ms per GC.</p>

<p>In general you don&#8217;t go about fiddling with the garbage collector unless you&#8217;ve noticed your application isn&#8217;t behaving as you would expect it to and that you&#8217;re unable to gaurantee stable performance behavior and after some investigation have found that the GC is in fact to be &#8220;blamed&#8221;. There are plenty of other situations in which tuning the GC can lead to a better performing Java application but I just wanted to show that even a badly written application can be &#8220;fixed&#8221; by a small change to the GC that is being used.</p></div>
             </article>
             <hr/>
             <div id="disqus_thread"></div>
             <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rodneyscorner'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
              </script>
              <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          <div class="span4">
            
                <h2>Related Posts</h2>
                <ul>
                    
                    <li><a href="/work/java/android/2011/03/09/21.00-android-development-and-ant.html">Android Development and Ant</a></li>
                    
                    <li><a href="/work/java/eclipse/2011/03/06/13.00-fixing-eclipse-content-assist.html">Fixing Eclipse Content Assist</a></li>
                    
                    <li><a href="/work/java/dtf/2011/01/28/23.00-new-generated-documentation-look-for-dtf.html">New look and feel for DTF documentation</a></li>
                    
                    <li><a href="/work/java/dtf/2011/01/17/16.00-continuous-integration-environment-for-dtf.html">Continuous Integration Environment for DTF</a></li>
                    
                    <li><a href="/work/java/dtf/2011/01/17/13.00-introducing-dtf.html">Introducing DTF</a></li>
                    
                </ul>
            
          </div>
        </div>
      </div>
      <footer>
        <div style="text-align: right">Powered by <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a></div>
        <div style="text-align: right">Last Updated: Wed May 16 16:16:15 -0700 2012</div>
      </footer>
    </div> <!-- /container -->
</html>
