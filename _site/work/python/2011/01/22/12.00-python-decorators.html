<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Python decorators</title>
        <meta name="description" content="Rodney's Blog">
        <meta name="author" content="Rodney Gomes">

        <link rel="alternate"
              type="application/rss+xml"
              title="Rodney's Corner RSS Feed"
              href="http://feeds.feedburner.com/rlgomesgithubcom/feed"/>

        <link href="/css/bootstrap.css" rel="stylesheet">
        <link href="/css/main.css" rel="stylesheet"/>
    </head>
    <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Rodney's Corner</a>
          <ul class="nav">
            <li class="active"><a href="/">Blog</a></li>
            <li><a href="/archive.html">Archive</a></li>
            <li><a href="/about.html">About</a></li>
          </ul>
        </div>
      </div>
    </div>

    <div class="container">
      <div class="content">
        <div class="page-header">
          <h1>Python decorators</h1>
        </div>
        <div class="row">
          <div class="span10">
             <article>
                   <div id="post.body"><p>I recently discovered decorators in Python and have been pretty impressed with how they work. Basically it allows you to change the behavior of a function or method without having to alter the code that represents that function. Instead with a decorator you basically label/annotate the method with a keyword that basically identifies which decorator to apply to this function.</p>

<p>Lets look at the simple example of you having creating a bunch of functions that do different tasks and then when you&#8217;re running in DEBUG mode you&#8217;d like to be able to get the amount of time spent on each of these calls. Lets first piece together a simple Python module with a few functions that do some simple tasks in it, for this example I&#8217;ve decided to create a simple logger module:</p>
<div class='highlight'><pre><code class='python'><span class='k'>def</span> <span class='nf'>i</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;I: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='k'>def</span> <span class='nf'>e</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;E: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='k'>def</span> <span class='nf'>d</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;D: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='k'>def</span> <span class='nf'>w</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;W: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>
</code></pre>
</div>
<p>There are four simple methods that log info, error, debug and warning messages and now we can design our perf module that will be used to decorate these methods so we can do things such as counting the occurrences of method calls or even just calculate the average time spent on these calls at runtime. Lets start by putting together the decorator that can calculate how much time we spent on each individual call.</p>

<p>So a decorator is nothing more than a function that accepts another function as an argument. The very basic decorator definition looks like so:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>import</span> <span class='nn'>time</span>

<span class='k'>def</span> <span class='nf'>track</span><span class='p'>(</span><span class='n'>f</span><span class='p'>):</span>
    <span class='k'>def</span> <span class='nf'>new_f</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>,</span> <span class='o'>**</span><span class='n'>kwargs</span><span class='p'>):</span>
        <span class='n'>t</span> <span class='o'>=</span> <span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span><span class='o'>*</span><span class='mi'>1000</span>
        <span class='n'>ret</span> <span class='o'>=</span> <span class='n'>f</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>,</span> <span class='o'>**</span><span class='n'>kwargs</span><span class='p'>)</span>
        <span class='n'>dur</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span> <span class='o'>*</span> <span class='mi'>1000</span><span class='p'>)</span> <span class='o'>-</span> <span class='n'>t</span>
        <span class='n'>name</span> <span class='o'>=</span> <span class='n'>f</span><span class='o'>.</span><span class='n'>__name__</span>
        <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;</span><span class='si'>%s</span><span class='s'> executed in </span><span class='si'>%d</span><span class='s'>ms&quot;</span> <span class='o'>%</span> <span class='p'>(</span><span class='n'>name</span><span class='p'>,</span> <span class='n'>dur</span><span class='p'>))</span>
        <span class='k'>return</span> <span class='n'>ret</span>

    <span class='k'>return</span> <span class='n'>new_f</span>
</code></pre>
</div>
<p>This is a decorator defined as a function you basically have to return a function as part of the contract of defining a decorator this way. In our case we create a simple function that wraps the existing one and return that. In this new function we&#8217;re just making the same call as your code intended but measuring the time spent. The <em>args</em> are the arguments passed to the original function and the <em>kwargs</em> are the keyword arguments passed to the original function.</p>

<p>Now Lets put together a silly test that simply logs a bunch of lines with our test logger. Here is this test:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>import</span> <span class='nn'>logger</span>

<span class='n'>logger</span><span class='o'>.</span><span class='n'>i</span><span class='p'>(</span><span class='s'>&quot;just a message&quot;</span><span class='p'>)</span>
<span class='n'>logger</span><span class='o'>.</span><span class='n'>e</span><span class='p'>(</span><span class='s'>&quot;oh crap!&quot;</span><span class='p'>)</span>
<span class='n'>logger</span><span class='o'>.</span><span class='n'>d</span><span class='p'>(</span><span class='s'>&quot;debug some stuff&quot;</span><span class='p'>)</span>
<span class='n'>logger</span><span class='o'>.</span><span class='n'>w</span><span class='p'>(</span><span class='s'>&quot;you should have a look a this&quot;</span><span class='p'>)</span>
</code></pre>
</div>
<p>We&#8217;re ready to go back to the original module and add the @track decorator to each of our calls. Our module will look like so:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>from</span> <span class='nn'>perf</span> <span class='kn'>import</span> <span class='n'>track</span>

<span class='nd'>@track</span>
<span class='k'>def</span> <span class='nf'>i</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;I: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='nd'>@track</span>
<span class='k'>def</span> <span class='nf'>e</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;E: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='nd'>@track</span>
<span class='k'>def</span> <span class='nf'>d</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;D: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>

<span class='nd'>@track</span>
<span class='k'>def</span> <span class='nf'>w</span><span class='p'>(</span><span class='n'>msg</span><span class='p'>):</span>
    <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;W: </span><span class='si'>%s</span><span class='s'>&quot;</span> <span class='o'>%</span> <span class='n'>msg</span><span class='p'>)</span>
</code></pre>
</div>
<p>When we execute our same test module we&#8217;ll now see the following in the logs</p>
<pre>
> python test.py
I: just a message
i executed in 0ms
E: oh crap!
e executed in 0ms
D: debug some stuff
d executed in 0ms
W: you should have a look a this
w executed in 0ms
</pre>
<p>Of course the amount of time spent is less than 0ms and that&#8217;s not a surprise but what you can see here is that we now have the ability to track the performance of these calls by simply marking them with the decorator keyword.</p>

<p>Lets take sometime to make that decorator extra smart and have it turned off/on based on a global DEBUG flag. The end result should look like so:</p>
<div class='highlight'><pre><code class='python'><span class='kn'>import</span> <span class='nn'>time</span>

<span class='k'>global</span> <span class='n'>DEBUG</span>
<span class='n'>DEBUG</span> <span class='o'>=</span> <span class='bp'>False</span>

<span class='k'>def</span> <span class='nf'>track</span><span class='p'>(</span><span class='n'>f</span><span class='p'>):</span>

    <span class='k'>global</span> <span class='n'>DEBUG</span>

    <span class='k'>if</span> <span class='p'>(</span> <span class='n'>DEBUG</span> <span class='p'>):</span>
        <span class='k'>def</span> <span class='nf'>new_f</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>,</span> <span class='o'>**</span><span class='n'>kwargs</span><span class='p'>):</span>
            <span class='n'>t</span> <span class='o'>=</span> <span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span><span class='o'>*</span><span class='mi'>1000</span>
            <span class='n'>ret</span> <span class='o'>=</span> <span class='n'>f</span><span class='p'>(</span><span class='o'>*</span><span class='n'>args</span><span class='p'>,</span> <span class='o'>**</span><span class='n'>kwargs</span><span class='p'>)</span>
            <span class='n'>dur</span> <span class='o'>=</span> <span class='p'>(</span><span class='n'>time</span><span class='o'>.</span><span class='n'>time</span><span class='p'>()</span> <span class='o'>*</span> <span class='mi'>1000</span><span class='p'>)</span> <span class='o'>-</span> <span class='n'>t</span>
            <span class='n'>name</span> <span class='o'>=</span> <span class='n'>f</span><span class='o'>.</span><span class='n'>__name__</span>
            <span class='k'>print</span><span class='p'>(</span><span class='s'>&quot;</span><span class='si'>%s</span><span class='s'> executed in </span><span class='si'>%d</span><span class='s'>ms&quot;</span> <span class='o'>%</span> <span class='p'>(</span><span class='n'>name</span><span class='p'>,</span> <span class='n'>dur</span><span class='p'>))</span>
            <span class='k'>return</span> <span class='n'>ret</span>

        <span class='k'>return</span> <span class='n'>new_f</span>
    <span class='k'>else</span><span class='p'>:</span>
        <span class='k'>return</span> <span class='n'>f</span>
</code></pre>
</div>
<p>This actually shows that you can make a decorator that adds no overhead when it is turned off because it just returns the same function that was already in place before the decorator had been used. Basically we can create a set of performance measuring decorators that have a negligible impact on our code when it running in production.</p>

<p>Of course there are more things that can be done with Python decorators but I just wanted to write up the starting point for future reference and hopefully inspire others to come up with some brilliant uses of Python decorators.</p>

<p>I created a small Eclipse project while writing this entry and you can get it from <a href='/images/decorators.tar.gz'>here</a> if you&#8217;d like.</p></div>
             </article>
             <hr/>
             <div id="disqus_thread"></div>
             <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'rodneyscorner'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
              </script>
              <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
              <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          <div class="span4">
            
                <h2>Related Posts</h2>
                <ul>
                    
                    <li><a href="/work/python/2011/12/21/20.00-memoize-decorator-for-python.html">Memoize decorator for python</a></li>
                    
                    <li><a href="/work/python/2011/06/03/00.00-python-performance-module.html">Python performance module</a></li>
                    
                    <li><a href="/work/python/2011/01/21/09.00-timetracker-with-toggl.html">Timetracker with toggl support</a></li>
                    
                    <li><a href="/work/python/2011/01/17/14.00-timetracker.html">Working on timetracker</a></li>
                    
                    <li><a href="/work/personal/2012/05/16/12.00-now-powered-by-boostrap-now.html">Now powered by bootstrap now</a></li>
                    
                </ul>
            
          </div>
        </div>
      </div>
      <footer>
        <div style="text-align: right">Powered by <a href="http://jekyllrb.com/">Jekyll</a> &amp; <a href="http://twitter.github.com/bootstrap/index.html">Bootstrap</a></div>
        <div style="text-align: right">Last Updated: Wed May 16 16:16:15 -0700 2012</div>
      </footer>
    </div> <!-- /container -->
</html>
